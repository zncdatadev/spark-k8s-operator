apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: logging
spec:
  bindings:
  - name: SPARK_MINIO_USER
    value: spark
  - name: SPARK_MINIO_PASSWORD
    value: sparkspark
  - name: SPARK_MINIO_BUCKET
    value: spark-history
  steps:
  # - name: foo
  #   try:
  #   - script:
  #       env:
  #         - name: product_version
  #           value: (env('PRODUCT_VERSION'))
  #       content: echo "product_version is $product_version"
  #   - apply:
  #       file: sparkhistoryserver.yaml
  #   - assert:
  #       file: sparkhistoryserver-assert.yaml
  - name: install minio
    try:
    - apply:
        file: ../setup/minio.yaml
    - assert:
        file: ../setup/minio-assert.yaml
  - name: install vector-aggregator
    try:
    - script:
        content: >-
          helm upgrade --install vector-aggregator vector
          --namespace $NAMESPACE
          --version 0.43.0
          --repo https://helm.vector.dev
          --values vector-aggregator-values.yaml
    - apply:
        file: vector-aggregator.yaml
    - assert:
        file: vector-aggregator-assert.yaml
  - name: install sparkhistoryserver cluster
    try:
    - apply:
        file: ../setup/minio-s3-connection.yaml
    - apply:
        file: sparkhistoryserver.yaml
    - assert:
        file: sparkhistoryserver-assert.yaml
  - name: assert sparkhistoryserver logs
    try:
    - sleep:
        duration: 120s
    - script:
        env:
          - name: NAMESPACE
            value: ($namespace)
        content: |
          #!/bin/bash
          # Get logs from vector-aggregator-0 and check for specific log pattern
          kubectl -n $NAMESPACE logs statefulset/vector-aggregator -c vector | \
            grep -q '"cluster":"sparkhistory","container":"node","errors":\[\],"file":"spark.log4j2.xml"'
          exit_code=$?

          if [ $exit_code -eq 0 ]; then
            echo "Found expected log pattern"
            exit 0
          else
            echo "Did not find expected log pattern"
            exit 1
          fi
    cleanup:
    catch:
      - script:
          env:
            - name: NAMESPACE
              value: ($namespace)
          content: |
            kubectl -n $NAMESPACE describe pods
      - podLogs:
          selector: app.kubernetes.io/instance=vector-aggregator
          tail: -1
      - podLogs:
          selector: app.kubernetes.io/instance=sparkhistory
          tail: -1
      - script:
          env:
            - name: NAMESPACE
              value: ($namespace)
          content: |
            POD=$(kubectl -n $NAMESPACE get pods -l app.kubernetes.io/name=sparkhistoryserver --field-selector status.phase=Running -o jsonpath='{.items[0].metadata.name}')
            echo "Printing log4j2.properties from Spark History Server pod $POD"
            kubectl -n $NAMESPACE exec $POD -- cat /kubedoop/config/log4j2.properties
            echo "Listing /kubedoop/log/node/ directory contents from Spark History Server pod $POD"
            kubectl -n $NAMESPACE exec $POD -- ls -alh /kubedoop/log/node/
            echo "Printing spark.log4j2.xml from Spark History Server pod $POD"
            kubectl -n $NAMESPACE exec $POD -c node -- cat /kubedoop/log/node/spark.log4j2.xml
