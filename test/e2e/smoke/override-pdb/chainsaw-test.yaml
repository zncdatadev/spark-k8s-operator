apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: smoke-override-pdb
spec:
  bindings:
  - name: SPARK_MINIO_USER
    value: spark
  - name: SPARK_MINIO_PASSWORD
    value: sparkspark
  - name: SPARK_MINIO_BUCKET
    value: spark-history
  steps:
  - name: install minio
    try:
    - apply:
        file: ../../setup/minio.yaml
    - assert:
        file: ../../setup/minio-assert.yaml
  - name: install sparkhistoryserver
    try:
    # install sparkhistoryserver sparkhistoryserver, clusterOperation.stopped: false, clusterOperation.reconciliationPaused: false
    - apply:
        file: ../../setup/minio-s3-connection.yaml
    - apply:
        file: sparkhistoryserver.yaml
    - assert:
        bindings:
          - name: available_replicas
            value: 1
        file: sparkhistoryserver-assert.yaml
  - name: assert pdb
    try:
    - assert:
        timeout: 240s
        resource:
          kind: PodDisruptionBudget
          apiVersion: policy/v1
          metadata:
            name: test-sparkhistoryserver-node
            namespace: ($namespace)
          spec:
            maxUnavailable: 1
          status:
            expectedPods: 2
            currentHealthy: 2
            disruptionsAllowed: 1
    catch:
      - script:
          content: |
            #!/bin/bash
            kubectl -n $NAMESPACE describe pods

  - name: assert podOverride
    try:
    - assert:
        file: sparkhistoryserver-assert.yaml
  - name: test env overrides
    try:
    - script:
        bindings:
        - name: NAMESPACE
          value: ($namespace)
        content: |
          #!/bin/bash
          kubectl -n $NAMESPACE get sts test-sparkhistoryserver-node-default -o yaml | yq -e '.spec.template.spec.containers[] | select (.name == "node") | .env[] | select (.name == "COMMON_VAR" and .value == "group-value")'
          kubectl -n $NAMESPACE get sts test-sparkhistoryserver-node-default -o yaml | yq -e '.spec.template.spec.containers[] | select (.name == "node") | .env[] | select (.name == "GROUP_VAR" and .value == "group-value")'
          kubectl -n $NAMESPACE get sts test-sparkhistoryserver-node-default -o yaml | yq -e '.spec.template.spec.containers[] | select (.name == "node") | .env[] | select (.name == "ROLE_VAR" and .value == "role-value")'
